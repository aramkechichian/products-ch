========================================
CONTEXTO DEL PROYECTO - Products API
========================================

PROYECTO: API REST con Laravel 10, Docker, PostgreSQL, Sanctum, Swagger

========================================
ARQUITECTURA
========================================

- Laravel 10+ (API-first)
- Docker (PHP 8.2-FPM, Nginx, PostgreSQL 15)
- PostgreSQL como base de datos
- Laravel Sanctum para autenticación (Bearer Tokens)
- Swagger (l5-swagger) para documentación API
- Laravel Excel (maatwebsite/excel) para exportación a Excel
- Estructura organizada por versiones (V1)

========================================
ESTRUCTURA DE CARPETAS
========================================

app/
  Http/
    Controllers/
      Api/
        Controller.php (base con success/error helpers)
        V1/
          Controller.php (base V1)
          Auth/
            AuthController.php (me, logoutAll)
            LoginController.php (login, logout)
            RegisterController.php (register)
          CurrencyController.php (CRUD completo)
          ProductController.php (CRUD completo)
          ProductPriceController.php (gestión de precios de productos)
          EventLogController.php (consulta de eventos)
    Requests/
      BaseRequest.php (base para JSON responses)
      V1/
        BaseRequest.php
        Auth/
          LoginRequest.php
          RegisterRequest.php
        StoreCurrencyRequest.php
        UpdateCurrencyRequest.php
        StoreProductRequest.php
        UpdateProductRequest.php
        SearchProductRequest.php
        StoreProductPriceRequest.php
    Resources/
      BaseResource.php (base con success wrapper)
      V1/
        BaseResource.php
        UserResource.php
        CurrencyResource.php
        ProductResource.php
        ProductPriceResource.php
        EventLogResource.php
    Middleware/
      Authenticate.php (maneja 401 para API)
  Models/
    User.php (con HasApiTokens)
    Currency.php
    Product.php
    ProductPrice.php
  Exports/
    ProductsExport.php (exportación a Excel)
    ProductPricesExport.php (exportación de product prices a Excel)
  Exceptions/
    Handler.php (maneja AuthenticationException, ValidationException, ModelNotFoundException)

routes/
  api.php (legacy)
  api/v1.php (rutas versionadas)
  web.php (solo health check)

database/
  migrations/
    - create_users_table
    - create_personal_access_tokens_table (Sanctum)
    - create_currencies_table
    - create_products_table
    - create_product_prices_table
  factories/
    - CurrencyFactory.php
    - ProductFactory.php
    - UserFactory.php

tests/
  Feature/
    CurrencyControllerTest.php (14 tests con DatabaseTransactions)

docker/
  nginx/default.conf
  php/
    php.ini
    www.conf
    docker-entrypoint.sh
  postgres/init.sql

scripts/
  setup.sh (configura .env, APP_KEY, PostgreSQL)
  start.sh (levanta Docker, instala dependencias, migraciones, Swagger)

========================================
ENDPOINTS IMPLEMENTADOS
========================================

AUTENTICACIÓN (públicos):
- POST /api/v1/auth/register
- POST /api/v1/auth/login

AUTENTICACIÓN (protegidos - requieren token):
- GET  /api/v1/auth/me
- POST /api/v1/auth/logout
- POST /api/v1/auth/logout-all

CURRENCIES (todos protegidos - requieren token):
- GET    /api/v1/currencies
- POST   /api/v1/currencies
- GET    /api/v1/currencies/{id}
- PUT    /api/v1/currencies/{id}
- DELETE /api/v1/currencies/{id}

PRODUCTS (todos protegidos - requieren token):
- GET    /api/v1/products
- POST   /api/v1/products (valida que currency_id exista, flag create_product_prices opcional)
- GET    /api/v1/products/{id}
- PUT    /api/v1/products/{id} (valida que currency_id exista si se envía)
- DELETE /api/v1/products/{id}
- GET    /api/v1/products/search (búsqueda avanzada con filtros opcionales)
- GET    /api/v1/products/export (descarga Excel con todos los productos)

PRODUCT PRICES (todos protegidos - requieren token):
- GET    /api/v1/products/{product}/prices (lista precios de un producto)
- POST   /api/v1/products/{product}/prices (crea/actualiza precio en otra moneda)
- GET    /api/v1/product-prices/export (descarga Excel con todos los product prices)

EVENT LOGS (todos protegidos - requieren token):
- GET    /api/v1/event-logs (lista eventos paginados con filtros)
- GET    /api/v1/event-logs/{id} (detalle de un evento)

========================================
MODELOS Y RELACIONES
========================================

Currency:
- id, name, symbol, exchange_rate
- hasMany: products, productPrices

Product:
- id, name, description, price, currency_id, tax_cost, manufacturing_cost
- belongsTo: currency
- hasMany: prices

ProductPrice:
- id, product_id, currency_id, price
- belongsTo: product, currency
- unique: [product_id, currency_id]

========================================
CONFIGURACIÓN IMPORTANTE
========================================

AUTENTICACIÓN:
- Middleware: auth:sanctum
- Error 401: {"success": false, "message": "Unauthenticated."}
- Handler maneja AuthenticationException

VALIDACIÓN:
- BaseRequest asegura respuestas JSON
- Mensajes de error en INGLÉS (todos los Form Requests)
- Handler maneja ValidationException (422)

ERRORES:
- 401: Unauthenticated
- 404: ModelNotFoundException (ej: Currency not found)
- 422: ValidationException
- 409: Conflict (ej: no se puede eliminar currency con productos)

SWAGGER:
- Configurado en config/l5-swagger.php
- Documentación en app/Http/Controllers/Controller.php (@OA\Info, @OA\Server, @OA\SecurityScheme)
- Schema Currency definido
- Todos los endpoints documentados con @OA\ annotations
- URL: http://localhost:8080/api/documentation

DOCKER:
- app: PHP 8.2-FPM
- nginx: puerto 8080
- postgres: puerto 5432
- Volúmenes: ./:/var/www/html (excluye vendor, node_modules)
- Hot reload habilitado (OPcache deshabilitado en desarrollo)

TESTS:
- Feature tests con DatabaseTransactions (rollback, no limpia datos previos)
- 14 tests para CurrencyController
- Scripts en composer.json: test, test:currency

========================================
SCRIPTS Y COMANDOS
========================================

LEVANTAR PROYECTO:
./scripts/start.sh
- Verifica .env
- Levanta Docker
- Instala dependencias si faltan
- Ejecuta migraciones
- Instala/configura Swagger
- Genera documentación
- Muestra logs

CONFIGURACIÓN INICIAL:
./scripts/setup.sh
- Crea .env desde .env.example
- Configura PostgreSQL
- Genera APP_KEY

TESTS:
docker-compose exec app php artisan test
docker-compose exec app composer test
docker-compose exec app composer test:currency

MIGRACIONES:
docker-compose exec app php artisan migrate
(se ejecutan automáticamente en start.sh)

SWAGGER:
docker-compose exec app php artisan l5-swagger:generate

========================================
DECISIONES DE DISEÑO
========================================

1. API-First: Solo JSON responses, no vistas
2. Versionado: Rutas en /api/v1/*
3. Autenticación: Bearer Tokens con Sanctum
4. Respuestas consistentes: {"success": bool, "message": string, "data": mixed}
5. Validación: Form Requests con mensajes en INGLÉS
6. Resources: Transforman modelos a JSON consistente
7. Tests: DatabaseTransactions (rollback, no afecta datos previos)
8. Docker: Hot reload para desarrollo
9. Inyección de Dependencias: Los controladores inyectan los modelos Eloquent en los métodos
   - Ejemplo: public function index(Request $request, Currency $currency)
   - Uso: $currency->newQuery() en lugar de Currency::query()
   - Ventajas: Facilita testing con mocks, mejor desacoplamiento, más profesional

========================================
PRÓXIMOS PASOS SUGERIDOS
========================================

- CRUD de Products ✅ (completado)
- CRUD de ProductPrices
- Endpoints para conversión de monedas
- Seeders para datos iniciales
- Más tests (Products, ProductPrices)
- Frontend simple para consumir la API

========================================
NOTAS IMPORTANTES
========================================

- Los tests usan DatabaseTransactions (rollback), no RefreshDatabase
- Swagger se genera automáticamente en start.sh
- Las migraciones se ejecutan automáticamente en start.sh
- El middleware Authenticate devuelve JSON para rutas /api/*
- Los errores 404 usan ModelNotFoundException
- Los endpoints protegidos requieren: Authorization: Bearer {token}
- TODOS los mensajes de validación están en INGLÉS (todos los Form Requests)
- Products valida que currency_id exista antes de crear/actualizar (exists:currencies,id)
- ProductResource incluye la relación currency cuando está cargada
- INYECCIÓN DE DEPENDENCIAS: Todos los controladores inyectan los modelos Eloquent en los métodos
  - CurrencyController: inyecta Currency en index, store, show, update, destroy
  - ProductController: inyecta Product en index, store, show, update, destroy, search
  - Uso: $model->newQuery() en lugar de Model::query(), $model->create() en lugar de Model::create()
  - Laravel resuelve automáticamente la inyección mediante el service container
  - Permite fácil mocking en tests: Mockery::mock(Currency::class)
- EXPORTACIÓN A EXCEL:
  - GET /api/v1/products/export: Exporta todos los productos
    - Formato: products_YYYY-MM-DD_HHmmss.xlsx
    - Columnas: ID, Name, Description, Price, Currency, Currency Symbol, Tax Cost, Manufacturing Cost, Created At, Updated At
  - GET /api/v1/product-prices/export: Exporta todos los product prices
    - Formato: product_prices_YYYY-MM-DD_HHmmss.xlsx
    - Columnas: Product Name, Currency Name, Price
    - Ordenado por product_id y currency_id
  - Ambos requieren autenticación (Bearer Token)
- SISTEMA DE EVENTOS (EVENTS_LOG): Registra automáticamente todos los POST, PUT, DELETE
  - Tabla: events_log
  - Campos: user_id, event_type (POST/PUT/DELETE), resource_type, resource_id, endpoint, method, data (JSON), ip_address, user_agent, timestamps
  - Servicio: EventLogService con métodos logCreate(), logUpdate(), logDelete()
  - Integrado en: CurrencyController (store, update, destroy), ProductController (store, update, destroy) y ProductPriceController (store)
  - Guarda: usuario autenticado, tipo de evento, recurso afectado, payload completo, IP, user agent, fecha/hora
  - Endpoints: GET /api/v1/event-logs (paginado con filtros), GET /api/v1/event-logs/{id}
- PRODUCT PRICES: Gestión de precios de productos en diferentes monedas
  - Endpoint POST /api/v1/products/{product}/prices: Crea o actualiza un precio para un producto en una moneda específica
    - Fórmula: product.price * currency.exchange_rate
    - Si ya existe, lo sobrescribe (updateOrCreate)
    - Registra evento POST (creación) o PUT (actualización)
    - No permite crear precio en la misma moneda base del producto
  - Endpoint GET /api/v1/products/{product}/prices: Lista todos los precios de un producto en diferentes monedas
    - Incluye relación currency
    - Ordenado por created_at (desc)
  - CREACIÓN AUTOMÁTICA: Al crear un producto, si no existe ningún product_price para ese producto, se crea automáticamente uno con:
    - product_id: ID del producto recién creado
    - currency_id: misma currency_id del producto
    - price: mismo price del producto (SIN multiplicar por exchange_rate, precio directo)
    - Esto solo ocurre si no existe ningún product_price para ese producto
  - FLAG create_product_prices: Campo opcional (boolean, default: false) en POST /api/v1/products
    - Si es true: Crea precios en todas las monedas (excepto la moneda base) usando price * exchange_rate
    - Si es false: Solo crea el producto (y el product_price inicial si no existe ninguno)
    - El flag funciona después de la creación automática del product_price inicial